--------------------------------------------------
test case: invalid config: invalid JSON (unexpected EOF)
input: 
ERROR: parse file: "/tmp/tst.layout.js": Unexpected end of JSON input
--------------------------------------------------
--------------------------------------------------
test case: invalid config: invalid JSON (unexpected "}")
input: }
ERROR: parse file: "/tmp/tst.layout.js": Unexpected token } in JSON at position 0
--------------------------------------------------
--------------------------------------------------
test case: invalid config: bad type
input: true
ERROR: property "": boolean value found, but a object is required
--------------------------------------------------
--------------------------------------------------
test case: raw JSON: trivial case
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "metadata",
            "uuid": "server_r01_metadata00",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "metadata",
            "uuid": "server_r02_metadata00",
            "memory": 64,
            "rack": "rack_r02"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r01_storage00",
            "memory": 64,
            "rack": "rack_r01"
        }
    ]
}

generated config:
{
    "server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            },
            "2": {
                "BORAY_IMAGE0": 1
            },
            "3": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            },
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            },
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            },
            "2": {
                "MORAY_IMAGE0": 1
            },
            "3": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "ops": {
            "OPS_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            },
            "2": {
                "POSTGRES_IMAGE0": 1
            },
            "3": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r01_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            },
            "2": {
                "BORAY_IMAGE0": 1
            },
            "3": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            },
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            },
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "madtom": {
            "MADTOM_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            },
            "2": {
                "MORAY_IMAGE0": 1
            },
            "3": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            },
            "2": {
                "POSTGRES_IMAGE0": 1
            },
            "3": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r02_metadata00": {
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            },
            "2": {
                "BORAY_IMAGE0": 1
            },
            "3": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            },
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            },
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            },
            "2": {
                "MORAY_IMAGE0": 1
            },
            "3": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            },
            "2": {
                "POSTGRES_IMAGE0": 1
            },
            "3": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "server_r01_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
warning: requested 3 shards with only 3 metadata servers in at least one datacenter.  Under some conditions, multiple databases may wind up running on the same servers.  This is not recommended.

summary:
     SERVICE          SHARD       default_az
     nameservice          -                3
     electric-moray       -                3
     storage              -                2
     authcache            -                2
     webapi               -                3
     loadbalancer         -                3
     ops                  -                1
     madtom               -                1
     reshard              -                 
     pgstatsmon           -                 
     garbage-collector     -                 
     prometheus           -                 
     buckets-api          -                3
     electric-boray       -                3
     postgres             1                3
     postgres             2                3
     postgres             3                3
     moray                1                3
     moray                2                3
     moray                3                3
     buckets-postgres     1                3
     buckets-postgres     2                3
     buckets-postgres     3                3
     boray                1                3
     boray                2                3
     boray                3                3
--------------------------------------------------
--------------------------------------------------
test case: invalid config: missing value (nshards)
input: {
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        }
    ]
}
ERROR: property "nshards": is missing and it is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: bad type (nshards)
input: {
    "nshards": 3.2,
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        }
    ]
}
ERROR: property "nshards": number value found, but a integer is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: bad value (nshards)
input: {
    "nshards": -3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        }
    ]
}
ERROR: property "nshards": must have a minimum value of 1
--------------------------------------------------
--------------------------------------------------
test case: invalid config: missing value (servers)
input: {
    "nshards": 3
}
ERROR: property "servers": is missing and it is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: bad type (servers)
input: {
    "nshards": 3,
    "servers": 7
}
ERROR: property "servers": number value found, but a array is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: empty list of servers
input: {
    "nshards": 3,
    "servers": []
}
ERROR: property "servers": there must be a minimum of 1 in the array
--------------------------------------------------
--------------------------------------------------
test case: invalid config: bad type for server
input: {
    "nshards": 3,
    "servers": [
        "foobar"
    ]
}
ERROR: property "servers[0]": string value found, but a object is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: server property bad value: "type"
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "junk"
        }
    ]
}
ERROR: property "servers[0].type": does not have a value in the enumeration metadata, storage
--------------------------------------------------
--------------------------------------------------
test case: invalid config: server property missing ("type")
input: {
    "nshards": 3,
    "servers": [
        {}
    ]
}
ERROR: property "servers[0].type": is missing and it is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: server property missing ("uuid")
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata"
        }
    ]
}
ERROR: property "servers[0].uuid": is missing and it is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: server property missing ("memory")
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "junkuuid"
        }
    ]
}
ERROR: property "servers[0].memory": is missing and it is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: bad type for server property ("uuid")
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": 17,
            "memory": 3
        }
    ]
}
ERROR: property "servers[0].uuid": number value found, but a string is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: bad type for server property ("memory")
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "junkuuid",
            "memory": {}
        }
    ]
}
ERROR: property "servers[0].memory": object value found, but a integer is required
--------------------------------------------------
--------------------------------------------------
test case: invalid config: no storage servers
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        }
    ]
}

generated config:
error: need at least one metadata server and one storage server
--------------------------------------------------
--------------------------------------------------
test case: invalid config: no metadata servers
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        }
    ]
}

generated config:
error: need at least one metadata server and one storage server
--------------------------------------------------
--------------------------------------------------
test case: invalid config: duplicate server
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        }
    ]
}
ERROR: server server_r00_metadata00, rack rack_r00, az default_az: duplicate server
--------------------------------------------------
--------------------------------------------------
test case: invalid config: same rack in different AZs
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "s000",
            "rack": "rack0",
            "az": "az1",
            "memory": 128
        },
        {
            "type": "storage",
            "uuid": "s001",
            "rack": "rack0",
            "az": "az2",
            "memory": 128
        }
    ]
}
ERROR: server s001, rack rack0, az az2: rack already exists in different az az1
--------------------------------------------------
--------------------------------------------------
test case: unsupported config: multiple AZs
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "s000",
            "rack": "rack0",
            "az": "az1",
            "memory": 128
        },
        {
            "type": "storage",
            "uuid": "s001",
            "rack": "rack1",
            "az": "az2",
            "memory": 128
        }
    ]
}

generated config:
error: only one- and three-datacenter deployments are supported
--------------------------------------------------
--------------------------------------------------
test case: trivial two-system case, 1 shard
input: {
    "nshards": 1,
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        }
    ]
}

generated config:
{
    "server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 2
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 3
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 2
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 3
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 2
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 2
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 2
        },
        "madtom": {
            "MADTOM_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 3
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 3
        },
        "ops": {
            "OPS_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 3
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 2
        }
    },
    "server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
warning: requested 1 shards with only 1 metadata server in at least one datacenter.  Under some conditions, multiple databases may wind up running on the same servers.  This is not recommended.
warning: configuration has only 1 rack.  This configuration may not survive rack failure.

summary:
     SERVICE          SHARD       default_az
     nameservice          -                3
     electric-moray       -                2
     storage              -                1
     authcache            -                2
     webapi               -                2
     loadbalancer         -                2
     ops                  -                1
     madtom               -                1
     reshard              -                 
     pgstatsmon           -                 
     garbage-collector     -                 
     prometheus           -                 
     buckets-api          -                2
     electric-boray       -                2
     postgres             1                3
     moray                1                3
     buckets-postgres     1                3
     boray                1                3
--------------------------------------------------
--------------------------------------------------
test case: trivial two-system case, 3 shards
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        }
    ]
}

generated config:
{
    "server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 2
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 3
            },
            "2": {
                "BORAY_IMAGE0": 3
            },
            "3": {
                "BORAY_IMAGE0": 3
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 2
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 3
            },
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 3
            },
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 3
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 2
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 2
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 2
        },
        "madtom": {
            "MADTOM_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 3
            },
            "2": {
                "MORAY_IMAGE0": 3
            },
            "3": {
                "MORAY_IMAGE0": 3
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 3
        },
        "ops": {
            "OPS_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 3
            },
            "2": {
                "POSTGRES_IMAGE0": 3
            },
            "3": {
                "POSTGRES_IMAGE0": 3
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 2
        }
    },
    "server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
warning: requested 3 shards with only 1 metadata server in at least one datacenter.  Multiple primary databases will wind up running on the same servers, and this configuration may not survive server failure.  This is not recommended.
warning: configuration has only 1 rack.  This configuration may not survive rack failure.

summary:
     SERVICE          SHARD       default_az
     nameservice          -                3
     electric-moray       -                2
     storage              -                1
     authcache            -                2
     webapi               -                2
     loadbalancer         -                2
     ops                  -                1
     madtom               -                1
     reshard              -                 
     pgstatsmon           -                 
     garbage-collector     -                 
     prometheus           -                 
     buckets-api          -                2
     electric-boray       -                2
     postgres             1                3
     postgres             2                3
     postgres             3                3
     moray                1                3
     moray                2                3
     moray                3                3
     buckets-postgres     1                3
     buckets-postgres     2                3
     buckets-postgres     3                3
     boray                1                3
     boray                2                3
     boray                3                3
--------------------------------------------------
--------------------------------------------------
test case: one rack with fewer servers
input: {
    "nshards": 2,
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "metadata",
            "uuid": "server_r00_metadata01",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "metadata",
            "uuid": "server_r00_metadata02",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "metadata",
            "uuid": "server_r01_metadata00",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "metadata",
            "uuid": "server_r01_metadata01",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "metadata",
            "uuid": "server_r01_metadata02",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "storage",
            "uuid": "server_r01_storage00",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "metadata",
            "uuid": "server_r02_metadata00",
            "memory": 64,
            "rack": "rack_r02"
        },
        {
            "type": "metadata",
            "uuid": "server_r02_metadata02",
            "memory": 64,
            "rack": "rack_r02"
        },
        {
            "type": "storage",
            "uuid": "server_r02_storage00",
            "memory": 64,
            "rack": "rack_r02"
        }
    ]
}

generated config:
{
    "server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r00_metadata01": {
        "boray": {
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "ops": {
            "OPS_IMAGE0": 1
        },
        "postgres": {
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r00_metadata02": {
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r01_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r01_metadata01": {
        "boray": {
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "madtom": {
            "MADTOM_IMAGE0": 1
        },
        "moray": {
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r01_metadata02": {
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r02_metadata00": {
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r02_metadata02": {
        "boray": {
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "server_r01_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "server_r02_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}

summary:
     SERVICE          SHARD       default_az
     nameservice          -                3
     electric-moray       -                8
     storage              -                3
     authcache            -                2
     webapi               -                8
     loadbalancer         -                8
     ops                  -                1
     madtom               -                1
     reshard              -                 
     pgstatsmon           -                 
     garbage-collector     -                 
     prometheus           -                 
     buckets-api          -                8
     electric-boray       -                8
     postgres             1                3
     postgres             2                3
     moray                1                3
     moray                2                3
     buckets-postgres     1                3
     buckets-postgres     2                3
     boray                1                3
     boray                2                3
--------------------------------------------------
--------------------------------------------------
test case: 3-rack, 4-shard deployment
input: {
    "nshards": 4,
    "servers": [
        {
            "type": "metadata",
            "uuid": "server_r00_metadata00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "metadata",
            "uuid": "server_r00_metadata01",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "metadata",
            "uuid": "server_r00_metadata02",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "metadata",
            "uuid": "server_r00_metadata03",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage00",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "storage",
            "uuid": "server_r00_storage01",
            "memory": 64,
            "rack": "rack_r00"
        },
        {
            "type": "metadata",
            "uuid": "server_r01_metadata00",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "metadata",
            "uuid": "server_r01_metadata01",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "metadata",
            "uuid": "server_r01_metadata02",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "metadata",
            "uuid": "server_r01_metadata03",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "storage",
            "uuid": "server_r01_storage00",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "storage",
            "uuid": "server_r01_storage01",
            "memory": 64,
            "rack": "rack_r01"
        },
        {
            "type": "metadata",
            "uuid": "server_r02_metadata00",
            "memory": 64,
            "rack": "rack_r02"
        },
        {
            "type": "metadata",
            "uuid": "server_r02_metadata01",
            "memory": 64,
            "rack": "rack_r02"
        },
        {
            "type": "metadata",
            "uuid": "server_r02_metadata02",
            "memory": 64,
            "rack": "rack_r02"
        },
        {
            "type": "metadata",
            "uuid": "server_r02_metadata03",
            "memory": 64,
            "rack": "rack_r02"
        },
        {
            "type": "storage",
            "uuid": "server_r02_storage00",
            "memory": 64,
            "rack": "rack_r02"
        },
        {
            "type": "storage",
            "uuid": "server_r02_storage01",
            "memory": 64,
            "rack": "rack_r02"
        }
    ]
}

generated config:
{
    "server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r00_metadata01": {
        "boray": {
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "ops": {
            "OPS_IMAGE0": 1
        },
        "postgres": {
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r00_metadata02": {
        "boray": {
            "3": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "3": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "3": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r00_metadata03": {
        "boray": {
            "4": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "4": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "4": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "4": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r01_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r01_metadata01": {
        "boray": {
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "madtom": {
            "MADTOM_IMAGE0": 1
        },
        "moray": {
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r01_metadata02": {
        "boray": {
            "3": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "3": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "3": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r01_metadata03": {
        "boray": {
            "4": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "4": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "4": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "4": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r02_metadata00": {
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r02_metadata01": {
        "boray": {
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r02_metadata02": {
        "boray": {
            "3": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "3": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "3": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r02_metadata03": {
        "boray": {
            "4": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "4": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "4": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "4": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "server_r00_storage01": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "server_r01_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "server_r01_storage01": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "server_r02_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "server_r02_storage01": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}

summary:
     SERVICE          SHARD       default_az
     nameservice          -                3
     electric-moray       -               12
     storage              -                6
     authcache            -                2
     webapi               -               12
     loadbalancer         -               12
     ops                  -                1
     madtom               -                1
     reshard              -                 
     pgstatsmon           -                 
     garbage-collector     -                 
     prometheus           -                 
     buckets-api          -               12
     electric-boray       -               12
     postgres             1                3
     postgres             2                3
     postgres             3                3
     postgres             4                3
     moray                1                3
     moray                2                3
     moray                3                3
     moray                4                3
     buckets-postgres     1                3
     buckets-postgres     2                3
     buckets-postgres     3                3
     buckets-postgres     4                3
     boray                1                3
     boray                2                3
     boray                3                3
     boray                4                3
--------------------------------------------------
--------------------------------------------------
test case: 3-AZ, 1-rack-per-AZ, 1-shard deployment
input: {
    "nshards": 1,
    "servers": [
        {
            "type": "metadata",
            "uuid": "az0_server_r00_metadata00",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "storage",
            "uuid": "az0_server_r00_storage00",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "metadata",
            "uuid": "az1_server_r00_metadata00",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "storage",
            "uuid": "az1_server_r00_storage00",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "metadata",
            "uuid": "az2_server_r00_metadata00",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        },
        {
            "type": "storage",
            "uuid": "az2_server_r00_storage00",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        }
    ]
}

generated config:
{
    "az0_server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "ops": {
            "OPS_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az0_server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
{
    "az1_server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "madtom": {
            "MADTOM_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az1_server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
{
    "az2_server_r00_metadata00": {
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az2_server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}

summary:
     SERVICE          SHARD              az0              az1              az2
     nameservice          -                1                1                1
     electric-moray       -                1                1                1
     storage              -                1                1                1
     authcache            -                1                1                 
     webapi               -                1                1                1
     loadbalancer         -                1                1                1
     ops                  -                1                                  
     madtom               -                                 1                 
     reshard              -                                                   
     pgstatsmon           -                                                   
     garbage-collector     -                                                   
     prometheus           -                                                   
     buckets-api          -                1                1                1
     electric-boray       -                1                1                1
     postgres             1                1                1                1
     moray                1                1                1                1
     buckets-postgres     1                1                1                1
     boray                1                1                1                1
--------------------------------------------------
--------------------------------------------------
test case: 3-AZ, 1-rack-per-AZ, 2-shard deployment
input: {
    "nshards": 2,
    "servers": [
        {
            "type": "metadata",
            "uuid": "az0_server_r00_metadata00",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "storage",
            "uuid": "az0_server_r00_storage00",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "metadata",
            "uuid": "az1_server_r00_metadata00",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "storage",
            "uuid": "az1_server_r00_storage00",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "metadata",
            "uuid": "az2_server_r00_metadata00",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        },
        {
            "type": "storage",
            "uuid": "az2_server_r00_storage00",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        }
    ]
}

generated config:
{
    "az0_server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            },
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            },
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            },
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "ops": {
            "OPS_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            },
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az0_server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
{
    "az1_server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            },
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            },
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "madtom": {
            "MADTOM_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            },
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            },
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az1_server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
{
    "az2_server_r00_metadata00": {
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            },
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            },
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            },
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            },
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az2_server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
warning: requested 2 shards with only 1 metadata server in at least one datacenter.  Multiple primary databases will wind up running on the same servers, and this configuration may not survive server failure.  This is not recommended.

summary:
     SERVICE          SHARD              az0              az1              az2
     nameservice          -                1                1                1
     electric-moray       -                1                1                1
     storage              -                1                1                1
     authcache            -                1                1                 
     webapi               -                1                1                1
     loadbalancer         -                1                1                1
     ops                  -                1                                  
     madtom               -                                 1                 
     reshard              -                                                   
     pgstatsmon           -                                                   
     garbage-collector     -                                                   
     prometheus           -                                                   
     buckets-api          -                1                1                1
     electric-boray       -                1                1                1
     postgres             1                1                1                1
     postgres             2                1                1                1
     moray                1                1                1                1
     moray                2                1                1                1
     buckets-postgres     1                1                1                1
     buckets-postgres     2                1                1                1
     boray                1                1                1                1
     boray                2                1                1                1
--------------------------------------------------
--------------------------------------------------
test case: 3-AZ, 2-racks-per-AZ, 3-shard deployment
input: {
    "nshards": 3,
    "servers": [
        {
            "type": "metadata",
            "uuid": "az0_server_r00_metadata00",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "storage",
            "uuid": "az0_server_r00_storage00",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "metadata",
            "uuid": "az0_server_r00_metadata01",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "storage",
            "uuid": "az0_server_r00_storage01",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "metadata",
            "uuid": "az0_server_r00_metadata02",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "storage",
            "uuid": "az0_server_r00_storage02",
            "memory": 64,
            "rack": "az0_rack_r00",
            "az": "az0"
        },
        {
            "type": "metadata",
            "uuid": "az1_server_r00_metadata00",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "storage",
            "uuid": "az1_server_r00_storage00",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "metadata",
            "uuid": "az1_server_r00_metadata01",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "storage",
            "uuid": "az1_server_r00_storage01",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "metadata",
            "uuid": "az1_server_r00_metadata02",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "storage",
            "uuid": "az1_server_r00_storage02",
            "memory": 64,
            "rack": "az1_rack_r00",
            "az": "az1"
        },
        {
            "type": "metadata",
            "uuid": "az2_server_r00_metadata00",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        },
        {
            "type": "storage",
            "uuid": "az2_server_r00_storage00",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        },
        {
            "type": "metadata",
            "uuid": "az2_server_r00_metadata01",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        },
        {
            "type": "storage",
            "uuid": "az2_server_r00_storage01",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        },
        {
            "type": "metadata",
            "uuid": "az2_server_r00_metadata02",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        },
        {
            "type": "storage",
            "uuid": "az2_server_r00_storage02",
            "memory": 64,
            "rack": "az2_rack_r00",
            "az": "az2"
        }
    ]
}

generated config:
{
    "az0_server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az0_server_r00_metadata01": {
        "boray": {
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "ops": {
            "OPS_IMAGE0": 1
        },
        "postgres": {
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az0_server_r00_metadata02": {
        "boray": {
            "3": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "3": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "3": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az0_server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "az0_server_r00_storage01": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "az0_server_r00_storage02": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
{
    "az1_server_r00_metadata00": {
        "authcache": {
            "AUTHCACHE_IMAGE0": 1
        },
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az1_server_r00_metadata01": {
        "boray": {
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "madtom": {
            "MADTOM_IMAGE0": 1
        },
        "moray": {
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az1_server_r00_metadata02": {
        "boray": {
            "3": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "3": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "3": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az1_server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "az1_server_r00_storage01": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "az1_server_r00_storage02": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}
{
    "az2_server_r00_metadata00": {
        "boray": {
            "1": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "1": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "1": {
                "MORAY_IMAGE0": 1
            }
        },
        "nameservice": {
            "NAMESERVICE_IMAGE0": 1
        },
        "postgres": {
            "1": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az2_server_r00_metadata01": {
        "boray": {
            "2": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "2": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "2": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "2": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az2_server_r00_metadata02": {
        "boray": {
            "3": {
                "BORAY_IMAGE0": 1
            }
        },
        "buckets-api": {
            "BUCKETS_API_IMAGE0": 1
        },
        "buckets-postgres": {
            "3": {
                "BUCKETS_POSTGRES_IMAGE0": 1
            }
        },
        "electric-boray": {
            "ELECTRIC_BORAY_IMAGE0": 1
        },
        "electric-moray": {
            "ELECTRIC_MORAY_IMAGE0": 1
        },
        "loadbalancer": {
            "LOADBALANCER_IMAGE0": 1
        },
        "moray": {
            "3": {
                "MORAY_IMAGE0": 1
            }
        },
        "postgres": {
            "3": {
                "POSTGRES_IMAGE0": 1
            }
        },
        "webapi": {
            "WEBAPI_IMAGE0": 1
        }
    },
    "az2_server_r00_storage00": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "az2_server_r00_storage01": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    },
    "az2_server_r00_storage02": {
        "storage": {
            "STORAGE_IMAGE0": 1
        }
    }
}

summary:
     SERVICE          SHARD              az0              az1              az2
     nameservice          -                1                1                1
     electric-moray       -                3                3                3
     storage              -                3                3                3
     authcache            -                1                1                 
     webapi               -                3                3                3
     loadbalancer         -                3                3                3
     ops                  -                1                                  
     madtom               -                                 1                 
     reshard              -                                                   
     pgstatsmon           -                                                   
     garbage-collector     -                                                   
     prometheus           -                                                   
     buckets-api          -                3                3                3
     electric-boray       -                3                3                3
     postgres             1                1                1                1
     postgres             2                1                1                1
     postgres             3                1                1                1
     moray                1                1                1                1
     moray                2                1                1                1
     moray                3                1                1                1
     buckets-postgres     1                1                1                1
     buckets-postgres     2                1                1                1
     buckets-postgres     3                1                1                1
     boray                1                1                1                1
     boray                2                1                1                1
     boray                3                1                1                1
--------------------------------------------------
