#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#

#
# Copyright 2019 Joyent, Inc.
#

#
# amon probes for the "ops" service
#
# For background information, see lib/alarms/index.js.  The format of this file
# is described in lib/alarms/metadata.js.
#

-
    event: upset.manta.ops.log_error
    legacyName: mackerel-logscan
    scope:
        service: ops
    checks:
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mackerel.log"
                fields:
                    level: FATAL
                threshold: 1
                period: 60
    ka:
        title: '"mackerel" logged an error'
        description: The "mackerel" subsystem has logged an error.
        severity: minor
        response: No automated response will be taken.
        impact: >-
            One or more metering reports may be missing or incomplete.
        action: >-
            Determine the scope of the problem based on the log message and
            resolve the underlying issue.

-
    event: upset.manta.ops.backup_unpack.log_error
    legacyName: mola-pg-transform-logscan-error,mola-pg-transform-logscan-fatal
    scope:
        service: ops
    checks:
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-pg-transform.log"
                fields:
                    level: ERROR
                threshold: 1
                period: 60
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-pg-transform.log"
                fields:
                    level: FATAL
                threshold: 1
                period: 60
    ka:
        title: '"mola-pg-transform" logged an error'
        description: The "mola-pg-transform" subsystem has logged an error.
        severity: minor
        response: No automated response will be taken.
        impact: >-
            The daily metadata backups may not have been unpacked.  Disk usage
            may accumulate on metadata and storage nodes until the problem is
            resolved.
        action: >-
            Determine the scope of the problem based on the log message and
            resolve the underlying issue.

-
    event: upset.manta.ops.gc.log_error
    legacyName: mola-logscan-error,mola-logscan-fatal
    scope:
        service: ops
    checks:
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola.log"
                fields:
                    level: ERROR
                threshold: 1
                period: 60
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola.log"
                fields:
                    level: FATAL
                threshold: 1
                period: 60
    ka:
        title: '"mola" logged an error'
        description: The garbage collection subsystem has logged an error.
        severity: minor
        response: No automated response will be taken.
        impact: >-
            Garbage collection may not be running.  Disk space used may
            accumulate on metadata and storage nodes until the problem is
            repaired.
        action: >-
            Determine the scope of the problem based on the log message and
            resolve the underlying issue.

-
    event: upset.manta.ops.gc.create_links_log_error
    legacyName: mola-gc-create-links-logscan-error,mola-gc-create-links-logscan-fatal
    scope:
        service: ops
    checks:
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-gc-create-links.log"
                fields:
                    level: ERROR
                threshold: 1
                period: 60
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-gc-create-links.log"
                fields:
                    level: FATAL
                threshold: 1
                period: 60
    ka:
        title: '"mola-gc-create-links" logged an error'
        description: The "mola-gc-create-links" subsystem has logged an error.
        severity: minor
        response: No automated response will be taken.
        impact: >-
            Garbage collection may not be running.  Disk space used may
            accumulate on metadata and storage  nodes until the problem is
            repaired.
        action: >-
            Determine the scope of the problem based on the log message and
            resolve the underlying issue.
-
    event: upset.manta.ops.gc.mpu_gc_log_error
    scope:
        service: ops
    checks:
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-mpu-gc.log"
                fields:
                    level: ERROR
                threshold: 1
                period: 60
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-mpu-gc.log"
                fields:
                    level: FATAL
                threshold: 1
                period: 60
    ka:
        title: '"mola-mpu-gc" logged an error'
        description:
            The garbage collection subsystem responsible for garbage collecting
            multipart uploads has logged an error.
        severity: minor
        response: No automated response will be taken.
        impact: >-
            Garbage collection of multipart uploads may not be running. Disk
            space used may accumulate on metadata and storage nodes until the
            problem is repaired.
        action: >-
            Determine the scope of the problem based on the log message and
            resolve the underlying issue.
-
    event: upset.manta.ops.gc.mpu_cleanup_log_error
    scope:
        service: ops
    checks:
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-mpu-cleanup.log"
                fields:
                    level: ERROR
                threshold: 1
                period: 60
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-mpu-cleanup.log"
                fields:
                    level: FATAL
                threshold: 1
                period: 60
    ka:
        title: '"mola-mpu-cleanup" logged an error'
        description:
            The garbage collection subsystem responsible for garbage collecting
            multipart uploads has logged an error.
        severity: minor
        response: No automated response will be taken.
        impact: >-
            Garbage collection of multipart uploads may not be running. Disk
            space used may accumulate on metadata and storage nodes until the
            problem is repaired.
        action: >-
            Determine the scope of the problem based on the log message and
            resolve the underlying issue.
-
    event: upset.manta.ops.gc.moray_gc_log_error
    legacyName: mola-moray-gc-logscan-error,mola-moray-gc-logscan-fatal
    scope:
        service: ops
    checks:
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-moray-gc.log"
                fields:
                    level: ERROR
                threshold: 1
                period: 60
        -
            type: bunyan-log-scan
            config:
                path: "/var/log/mola-moray-gc.log"
                fields:
                    level: FATAL
                threshold: 1
                period: 60
    ka:
        title: '"mola-moray-gc" logged an error'
        description: The "mola-moray-gc" subsystem has logged an error.
        severity: minor
        response: No automated response will be taken.
        impact: >-
            Garbage collection may not be running.  Disk space used may
            accumulate on metadata nodes until the problem is repaired.
        action: >-
            Determine the scope of the problem based on the log message and
            resolve the underlying issue.

-
    event: upset.manta.ops.dumps_missing
    legacyName: manatee-backups-failed
    scope:
        service: ops
    checks:
        -
            type: cmd
            config:
                cmd: "export HOME=/root && . /root/.bashrc && export DATE=$(date +'%Y/%m/%d/00' --date='7 hours ago'); echo $DATE; for s in $(mls /poseidon/stor/manatee_backups | tr -d '/'); do /opt/local/bin/echo -n \"$s \"; until [[ \"$MLS\" != '' ]]; do export MLS=$(mls /poseidon/stor/manatee_backups/$s/$DATE 2>&1); done; echo \"$MLS\" | grep '\\(manta_delete_log-\\)\\|\\(marlin_tasks_v2-\\)' >/dev/null; if [[ $? == 0 ]]; then echo 'pass'; else echo 'fail'; fi; export MLS=''; done"
                interval: 300
                threshold: 1
                period: 3600
                timeout: 60
                stdoutMatch:
                    pattern: fail
                    type: substring
    ka:
        title: Unpacked metadata dumps are missing
        description: Regularly-scheduled metadata dumps have not been unpacked
        severity: major
        response: No automated response will be taken.
        impact: >-
            The regularly scheduled metadata backups may not have been unpacked.
            Disk usage may accumulate on metadata and storage nodes until the
            problem is resolved.
        action: >-
            The "manta-hk" tool can be used in the "ops" zone to determine
            whether the regularly-scheduled dumps have been uploaded and
            unpacked.
